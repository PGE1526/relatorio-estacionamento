<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Relatório diário PGE — Visualização pública</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body{font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;}
    .preview-img{max-width:140px;border-radius:6px}
    .preview-grid{display:flex;flex-wrap:wrap;gap:8px}
    .hidden{display:none}
    .tab-btn-active{background:#1e40af;color:white}
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

<header class="bg-white shadow sticky top-0 z-40">
  <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
    <div>
      <h1 class="text-lg font-bold">Relatório diário PGE</h1>
      <p class="text-sm text-gray-500">Todos os registros são públicos — visualização em tempo real</p>
    </div>
    <div class="flex items-center gap-2">
      <button id="prevDay" class="px-3 py-2 rounded bg-gray-100">◀</button>
      <input id="datePicker" type="date" class="border rounded px-3 py-2 bg-white" />
      <button id="nextDay" class="px-3 py-2 rounded bg-gray-100">▶</button>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-6 space-y-6">

  <nav class="bg-white rounded shadow p-3">
    <div class="flex gap-2 overflow-x-auto">
      <button id="tabAll" class="tabbtn px-3 py-2 rounded bg-blue-600 text-white">Tudo</button>
      <button id="tabVeiculos" class="tabbtn px-3 py-2 rounded bg-white border">Veículos</button>
      <button id="tabFechamento" class="tabbtn px-3 py-2 rounded bg-white border">Fechamento P4</button>
      <button id="tabRelatorio" class="tabbtn px-3 py-2 rounded bg-white border">Relatórios</button>
      <button id="tabBicicleta" class="tabbtn px-3 py-2 rounded bg-white border">Bicicleta</button>
      <button id="tabInfo" class="tabbtn px-3 py-2 rounded bg-white border">Informações</button>
    </div>
  </nav>

  <section class="bg-white rounded shadow p-4">
    <h2 class="font-semibold mb-3">Registros</h2>

    <div id="loading" class="text-sm text-gray-500 mb-3">Carregando registros...</div>

    <div id="recordsContainer" class="space-y-4">
      <!-- aqui aparecerão os cartões de registros -->
    </div>

    <div id="noRecords" class="text-sm text-gray-500 hidden">Nenhum registro encontrado para a data selecionada.</div>
  </section>

</main>

<script>
/* ------------- CONFIG ------------- */
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycby2Ftp5u1u6nJ5AJdy7gWuzEK7inZvSTT3Tx1IPAVY4tMI9BJpneFHEiAt0l20_eiGv/exec";

/* ------------- DOM ------------- */
const datePicker = document.getElementById('datePicker');
const prevDay = document.getElementById('prevDay');
const nextDay = document.getElementById('nextDay');
const recordsContainer = document.getElementById('recordsContainer');
const loadingEl = document.getElementById('loading');
const noRecords = document.getElementById('noRecords');

const tabAll = document.getElementById('tabAll');
const tabVeiculos = document.getElementById('tabVeiculos');
const tabFechamento = document.getElementById('tabFechamento');
const tabRelatorio = document.getElementById('tabRelatorio');
const tabBicicleta = document.getElementById('tabBicicleta');
const tabInfo = document.getElementById('tabInfo');

let activeFilter = 'all'; // all, veiculo, fechamento, relatorio, bicicleta, informacoes

/* ------------- inicialização ------------- */
function isoDate(d){ return d.toISOString().slice(0,10); }
datePicker.value = isoDate(new Date());
loadAndRender();

prevDay.addEventListener('click', ()=>{ const d=new Date(datePicker.value); d.setDate(d.getDate()-1); datePicker.value = isoDate(d); loadAndRender(); });
nextDay.addEventListener('click', ()=>{ const d=new Date(datePicker.value); d.setDate(d.getDate()+1); datePicker.value = isoDate(d); loadAndRender(); });
datePicker.addEventListener('change', loadAndRender);

tabAll.addEventListener('click', ()=>{ setActive('all'); renderCached(); });
tabVeiculos.addEventListener('click', ()=>{ setActive('veiculo'); renderCached(); });
tabFechamento.addEventListener('click', ()=>{ setActive('fechamento'); renderCached(); });
tabRelatorio.addEventListener('click', ()=>{ setActive('relatorio'); renderCached(); });
tabBicicleta.addEventListener('click', ()=>{ setActive('bicicleta'); renderCached(); });
tabInfo.addEventListener('click', ()=>{ setActive('informacoes'); renderCached(); });

function setActive(filter){
  activeFilter = filter;
  document.querySelectorAll('.tabbtn').forEach(b => b.classList.remove('bg-blue-600','text-white'));
  if(filter==='all') tabAll.classList.add('bg-blue-600','text-white');
  if(filter==='veiculo') tabVeiculos.classList.add('bg-blue-600','text-white');
  if(filter==='fechamento') tabFechamento.classList.add('bg-blue-600','text-white');
  if(filter==='relatorio') tabRelatorio.classList.add('bg-blue-600','text-white');
  if(filter==='bicicleta') tabBicicleta.classList.add('bg-blue-600','text-white');
  if(filter==='informacoes') tabInfo.classList.add('bg-blue-600','text-white');
}

/* cache dos registros do último carregamento */
let cachedRecords = [];

/* ------------- buscar registros do WebApp ------------- */
async function fetchRecords(date){
  try {
    loadingEl.style.display = 'block';
    recordsContainer.innerHTML = '';
    noRecords.classList.add('hidden');

    const qs = new URLSearchParams({ action:'list', date: date });
    const res = await fetch(WEBAPP_URL + '?' + qs.toString());
    const json = await res.json();
    if(!json || !json.ok) {
      loadingEl.textContent = 'Erro ao carregar registros.';
      console.error('Erro fetchRecords', json);
      return [];
    }
    loadingEl.style.display = 'none';
    return json.records || [];
  } catch(err) {
    loadingEl.textContent = 'Erro de rede ao carregar registros.';
    console.error('fetchRecords error', err);
    return [];
  }
}

/* ------------- render ------------- */
function makeCard(rec) {
  // rec: { filename, url, date, section, tipo, contentRaw, content }
  const div = document.createElement('div');
  div.className = 'border rounded p-3 bg-gray-50';

  const header = document.createElement('div');
  header.className = 'flex justify-between items-start gap-4';

  const left = document.createElement('div');
  left.innerHTML = `<div class="text-sm font-semibold">${escapeHtml(rec.tipo || rec.section || 'registro')}</div>
                    <div class="text-xs text-gray-600">Data: ${escapeHtml(rec.date || '')} • Pasta: ${escapeHtml(rec.section || '')}</div>
                    <div class="text-xs mt-1"><a target="_blank" href="${rec.url}" class="text-blue-600 underline">Abrir arquivo</a></div>`;

  header.appendChild(left);

  div.appendChild(header);

  // conteúdo principal: se rec.content é objeto JSON com payload, mostramos campos relevantes
  const body = document.createElement('div');
  body.className = 'mt-3 text-sm';

  let content = rec.content;
  if(!content && rec.contentRaw) {
    // tenta extrair payload manualmente se o JSON tiver chave payload
    try {
      const parsed = JSON.parse(rec.contentRaw);
      content = parsed.payload || parsed;
    } catch(e){}
  }

  if (content && typeof content === 'object') {
    // formatamos alguns tipos comuns
    if (content._tipo === 'veiculo' || rec.tipo==='veiculo' || rec.section.toLowerCase().indexOf('veiculo')!==-1) {
      const p = content.payload || content;
      body.innerHTML = `<div><strong>Placa:</strong> ${escapeHtml((p.placa||p.placa||''))}</div>
                        <div><strong>Hora:</strong> ${escapeHtml(p.hora||'')}</div>
                        <div><strong>Motivo:</strong> ${escapeHtml(p.motivo||'')}</div>
                        <div><strong>Operador:</strong> ${escapeHtml(p.operador||'')}</div>`;
    } else if (rec.tipo==='fechamento' || rec.section.toLowerCase().indexOf('fechamento')!==-1 || content._tipo==='fechamento') {
      const p = content.payload || content;
      body.innerHTML = `<div><strong>Alterações:</strong><div class="mt-1 preserve">${escapeHtml(p.alteracoes||'')}</div></div>
                        <div class="mt-2"><strong>Credencial:</strong> ${p.credencial? 'Sim':'Não'} • <strong>Chave:</strong> ${p.chave? 'Sim':'Não'}</div>
                        <div class="mt-1"><strong>Horas:</strong> ${escapeHtml((p.horaEntrada||'') + ' / ' + (p.horaSaida||'') + ' / ' + (p.horaPedestre||''))}</div>`;
    } else if (rec.tipo==='relatorio' || rec.section.toLowerCase().indexOf('relatorio')!==-1 || content._tipo==='relatorio') {
      const p = content.payload || content;
      body.innerHTML = `<div><strong>Nome:</strong> ${escapeHtml(p.nome||'')}</div>
                        <div><strong>Turno:</strong> ${escapeHtml(p.turno||'')}</div>
                        <div class="mt-1 preserve">${escapeHtml(p.info||'')}</div>`;
    } else if (rec.tipo==='bicicleta' || rec.section.toLowerCase().indexOf('bicicleta')!==-1 || content._tipo==='bicicleta') {
      const p = content.payload || content;
      let vals = (p.valores && Array.isArray(p.valores)) ? p.valores.join(', ') : (p.valores ? JSON.stringify(p.valores) : '');
      body.innerHTML = `<div><strong>Anotações:</strong><div class="mt-1 preserve">${escapeHtml(p.anotacoes||'')}</div></div>
                        <div class="mt-2"><strong>Valores:</strong> ${escapeHtml(vals)}</div>`;
    } else if (rec.tipo==='informacoes' || rec.section.toLowerCase().indexOf('informacoes')!==-1 || content._tipo==='informacoes') {
      const p = content.payload || content;
      body.innerHTML = `<div class="preserve">${escapeHtml(p.descricao||'')}</div>`;
    } else {
      // generic: pretty print payload
      const p = content.payload || content;
      body.innerHTML = `<pre style="white-space:pre-wrap;font-size:12px">${escapeHtml(JSON.stringify(p, null, 2))}</pre>`;
    }
  } else {
    // não é JSON parseável — mostra raw
    body.innerHTML = `<pre style="white-space:pre-wrap;font-size:12px">${escapeHtml(rec.contentRaw || '')}</pre>`;
  }

  div.appendChild(body);

  // se houver imagens no JSON (ex: fotos em Base64) não tentamos renderizar aqui — apenas links
  return div;
}

function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ------------- carregar e renderizar ------------- */
async function loadAndRender() {
  const date = datePicker.value;
  loadingEl.style.display = 'block';
  recordsContainer.innerHTML = '';
  noRecords.classList.add('hidden');

  const records = await fetchRecords(date);
  cachedRecords = records || [];
  loadingEl.style.display = 'none';
  renderCached();
}

function renderCached() {
  recordsContainer.innerHTML = '';
  const records = cachedRecords || [];
  const filtered = records.filter(r => {
    if (activeFilter === 'all') return true;
    if (activeFilter === 'informacoes') return (r.tipo==='informacoes' || r.section.toLowerCase().indexOf('informacoes')!==-1);
    return ( (r.tipo && r.tipo.toLowerCase() === activeFilter) || (r.section && r.section.toLowerCase() === activeFilter) );
  });

  if (filtered.length === 0) {
    noRecords.classList.remove('hidden');
    return;
  } else {
    noRecords.classList.add('hidden');
  }

  filtered.forEach(r => {
    const card = makeCard(r);
    recordsContainer.appendChild(card);
  });
}

/* ------------- auto-refresh opcional (a cada 30s) ------------- */
let autoRefreshTimer = null;
function startAutoRefresh() {
  if (autoRefreshTimer) clearInterval(autoRefreshTimer);
  autoRefreshTimer = setInterval(loadAndRender, 30000); // 30s
}
startAutoRefresh();

</script>

</body>
</html>
