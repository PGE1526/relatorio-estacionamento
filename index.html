<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Relatório diário PGE</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    .watermark { position: fixed; left:50%; top:50%; transform:translate(-50%,-50%); pointer-events:none; z-index:5; opacity:0.06; width:60vmin; max-width:900px; filter:grayscale(100%); }
    .watermark img{width:100%;height:auto;display:block}
    main{position:relative;z-index:10}
    .preserve{white-space:pre-wrap; word-break:break-word}
    .menu,#modalEdit{z-index:60}
    textarea, input { font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; font-size:14px; line-height:1.4; }
    .preview-img{max-width:160px; border-radius:6px; box-shadow:0 0 6px rgba(0,0,0,0.08)}
    .preview-grid{display:flex; flex-wrap:wrap; gap:10px}
    /* For mobile tab visibility: make nav horizontally scrollable and allow buttons to flex */
    .tabs-scroll { overflow-x:auto; -webkit-overflow-scrolling:touch; }
    .tabs-row { display:flex; gap:8px; padding:6px; }
    .tabs-row button { flex: 0 0 auto; white-space:nowrap; }
    @media (max-width:640px){
      .tabs-row { gap:6px; }
      .tabs-row button { padding-left:10px;padding-right:10px;}
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

  <div class="watermark" aria-hidden="true"><img src="logo.png" alt="Marca d'água PGE"></div>

  <header class="bg-white shadow-sm sticky top-0 z-40">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between gap-4">
      <div>
        <h1 class="text-lg font-bold">Relatório diário PGE</h1>
        <p class="text-sm text-gray-500">Registros por dia: Veículos, Bicicleta, Fechamento, Relatório, Informações supervisor</p>
      </div>
      <div class="flex items-center gap-2">
        <button id="prevDay" class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200">◀</button>
        <input id="datePicker" type="date" class="border rounded px-3 py-2 bg-white" />
        <button id="nextDay" class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200">▶</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">

    <nav class="bg-white rounded shadow p-0">
      <div class="tabs-scroll">
        <div class="tabs-row">
          <button id="tabVeiculosBtn" class="tablink px-4 py-2 rounded bg-blue-600 text-white font-semibold">Veículos</button>
          <button id="tabBicicletaBtn" class="tablink px-4 py-2 rounded bg-white text-gray-700 border">Bicicleta</button>
          <button id="tabFechamentoBtn" class="tablink px-4 py-2 rounded bg-white text-gray-700 border">Fechamento da P4</button>
          <button id="tabRelatorioBtn" class="tablink px-4 py-2 rounded bg-white text-gray-700 border">Relatório diário operador</button>
          <button id="tabInfoBtn" class="tablink px-4 py-2 rounded bg-white text-gray-700 border">Informações supervisor</button>
        </div>
      </div>
    </nav>

    <!-- Veículos -->
    <section id="veiculos" class="tabcontent block">
      <div class="grid md:grid-cols-2 gap-6">
        <div class="bg-white rounded shadow p-4">
          <h2 class="font-semibold mb-3">Registrar saída</h2>
          <form id="formVeiculos" class="space-y-3" novalidate>
            <div>
              <label class="block text-sm font-medium mb-1">Placa</label>
              <input type="text" id="placaInput" maxlength="8" class="w-full border rounded px-3 py-2" placeholder="ABC-1234" autocomplete="off">
              <p id="placaErro" class="hidden text-sm text-red-600 mt-1">Placa inválida.</p>
            </div>
            <div><label class="block text-sm font-medium mb-1">Hora</label><input type="time" id="horaInput" class="w-full border rounded px-3 py-2"></div>
            <div><label class="block text-sm font-medium mb-1">Motivo</label><input type="text" id="motivoInput" class="w-full border rounded px-3 py-2"></div>
            <div><label class="block text-sm font-medium mb-1">Operador</label><input type="text" id="operadorInput" class="w-full border rounded px-3 py-2"></div>
            <div class="flex items-center gap-3"><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Registrar</button><span id="msgVeiculo" class="text-sm text-green-700 hidden">Registro salvo.</span></div>
          </form>
        </div>

        <div class="bg-white rounded shadow p-4">
          <h2 class="font-semibold mb-3">Registros do dia</h2>
          <div class="overflow-x-auto">
            <table class="table-auto w-full table-fixed text-sm">
              <colgroup><col style="width:14%"><col style="width:14%"><col style="width:44%"><col style="width:18%"><col style="width:10%"></colgroup>
              <thead><tr class="bg-gray-100"><th class="px-3 py-2 text-left">Placa</th><th class="px-3 py-2 text-left">Hora</th><th class="px-3 py-2 text-left">Motivo</th><th class="px-3 py-2 text-left">Operador</th><th class="px-3 py-2 text-left"></th></tr></thead>
              <tbody id="registrosVeiculosBody" class="align-top"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Bicicleta -->
    <section id="bicicleta" class="tabcontent hidden">
      <div id="bicicletaCard" class="bg-white rounded shadow p-4 space-y-4 relative">
        <div class="absolute inset-0 flex items-center justify-center pointer-events-none z-0" aria-hidden="true">
          <img src="logo.png" alt="" style="width:60%;opacity:0.03;filter:grayscale(100%);">
        </div>

        <div class="flex items-center justify-between relative z-10">
          <h2 class="font-semibold">Controle de Bicicleta</h2>
          <div class="flex items-center gap-2">
            <button id="btnCompartilhar" class="bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 text-sm">Compartilhar</button>
            <span id="msgBic" class="text-sm text-green-700 hidden">Salvo.</span>
          </div>
        </div>

        <div class="overflow-x-auto relative z-10">
          <table class="table-auto w-full text-sm">
            <thead><tr class="bg-gray-100"><th class="px-3 py-2 text-left">Horário</th><th class="px-3 py-2 text-left">Preenchimento</th></tr></thead>
            <tbody id="bicicletaTable"></tbody>
          </table>
        </div>

        <div class="relative z-10">
          <label class="block text-sm font-medium mb-1">Anotações</label>
          <textarea id="anotacoesBicicleta" rows="3" class="w-full border rounded px-3 py-2" placeholder="Ex: bicicleta foi recolhida; corrente colocada..."></textarea>
        </div>

        <div class="font-semibold relative z-10">Média dos valores: <span id="mediaBicicleta">0,00</span></div>

        <div class="relative z-10 pt-2 border-t">
          <label class="block text-sm font-medium mb-1">Foto da Bicicleta</label>
          <input type="file" id="fotoBicicleta" accept="image/*" capture="environment" class="border rounded px-3 py-2 w-full">
          <div class="preview-grid mt-3" id="previewBicicleta"></div>
        </div>
      </div>
    </section>

    <!-- Fechamento -->
    <section id="fechamento" class="tabcontent hidden">
      <div class="bg-white rounded shadow p-4 space-y-4">
        <h2 class="font-semibold">Fechamento da P4</h2>
        <form id="formFechamento" class="space-y-3" novalidate>
          <div><label class="block text-sm font-medium mb-1">Alterações nos terminais</label><textarea id="alteracoesTerminais" rows="4" class="w-full border rounded px-3 py-2" placeholder="Descreva alterações..."></textarea></div>
          <div class="flex gap-6"><label class="inline-flex items-center gap-2"><input type="checkbox" id="credencialGuarita"> Credencial está na guarita</label><label class="inline-flex items-center gap-2"><input type="checkbox" id="chaveGuarita"> Chave está na guarita</label></div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div><label class="block text-sm font-medium mb-1">Horário fechamento entrada</label><input type="time" id="horaFechEntrada" class="w-full border rounded px-3 py-2"></div>
            <div><label class="block text-sm font-medium mb-1">Horário fechamento saída</label><input type="time" id="horaFechSaida" class="w-full border rounded px-3 py-2"></div>
            <div><label class="block text-sm font-medium mb-1">Horário fechamento pedestre</label><input type="time" id="horaFechPedestre" class="w-full border rounded px-3 py-2"></div>
          </div>
          <div class="flex items-center gap-3"><button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Salvar Fechamento</button><span id="msgFech" class="text-sm text-green-700 hidden">Salvo.</span></div>
        </form>

        <div class="mt-2"><h3 class="font-medium mb-2">Fechamentos do dia</h3><div id="listaFechamentos" class="space-y-3"></div></div>

        <div class="pt-2 border-t">
          <label class="block text-sm font-medium mb-1">Foto do Fechamento</label>
          <input type="file" id="fotoFechamento" accept="image/*" capture="environment" class="border rounded px-3 py-2 w-full">
          <div class="preview-grid mt-3" id="previewFechamento"></div>
        </div>
      </div>
    </section>

    <!-- Relatório -->
    <section id="relatorio" class="tabcontent hidden">
      <div class="bg-white rounded shadow p-4 space-y-4">
        <h2 class="font-semibold">Relatório diário operador</h2>
        <form id="formRelatorio" class="space-y-3" novalidate>
          <div><label class="block text-sm font-medium mb-1">Nome</label><input type="text" id="relNome" class="w-full border rounded px-3 py-2"></div>
          <div><label class="block text-sm font-medium mb-1">Data</label><input type="date" id="relData" class="w-full border rounded px-3 py-2"></div>
          <div><label class="block text-sm font-medium mb-1">Turno</label><select id="relTurno" class="w-full border rounded px-3 py-2"><option value="08-20">08:00 - 20:00</option><option value="11-23">11:00 - 23:00</option><option value="13-01">13:00 - 01:00</option></select></div>
          <div><label class="block text-sm font-medium mb-1">Informações do dia</label><textarea id="relInfo" rows="6" class="w-full border rounded px-3 py-2" placeholder="Anotações gerais do operador..."></textarea></div>
          <div class="flex items-center gap-3"><button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded hover:bg-emerald-700">Salvar Relatório</button><span id="msgRel" class="text-sm text-green-700 hidden">Salvo.</span></div>
        </form>

        <div class="mt-3"><h3 class="font-medium mb-2">Relatórios do dia</h3><div id="listaRelatorios" class="space-y-3"></div></div>

        <div class="pt-2 border-t">
          <label class="block text-sm font-medium mb-1">Foto do Relatório</label>
          <input type="file" id="fotoRelatorio" accept="image/*" capture="environment" class="border rounded px-3 py-2 w-full">
          <div class="preview-grid mt-3" id="previewRelatorio"></div>
        </div>
      </div>
    </section>

    <!-- Informações supervisor -->
    <section id="info" class="tabcontent hidden">
      <div class="bg-white rounded shadow p-4 space-y-4">
        <h2 class="font-semibold">Informações supervisor</h2>
        <p class="text-sm text-gray-600">Adicione fotos gerais do dia e observações do supervisor. Clique em Salvar Informações para gravar no Drive.</p>

        <div>
          <label class="block text-sm font-medium mb-1">Foto</label>
          <input type="file" id="fotoInfo" accept="image/*" capture="environment" class="border rounded px-3 py-2 w-full">
          <div class="preview-grid mt-3" id="previewInfo"></div>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Descrição do supervisor</label>
          <textarea id="infoDescricao" rows="4" class="w-full border rounded px-3 py-2" placeholder="Observações do supervisor..."></textarea>
        </div>

        <div class="flex gap-3">
          <button id="btnSalvarInfo" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Salvar Informações</button>
          <span id="msgInfo" class="text-sm text-green-700 hidden">Informações salvas.</span>
        </div>
      </div>
    </section>

  </main>

  <!-- Modal edição veículo -->
  <div id="modalEdit" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white rounded shadow p-4 w-full max-w-md">
      <h4 class="font-semibold mb-3">Editar Registro</h4>
      <div class="space-y-3">
        <div><label class="block text-sm font-medium mb-1">Placa</label><input id="editPlaca" class="w-full border rounded px-3 py-2" maxlength="8"></div>
        <div><label class="block text-sm font-medium mb-1">Hora</label><input id="editHora" type="time" class="w-full border rounded px-3 py-2"></div>
        <div><label class="block text-sm font-medium mb-1">Motivo</label><input id="editMotivo" class="w-full border rounded px-3 py-2"></div>
        <div><label class="block text-sm font-medium mb-1">Operador</label><input id="editOperador" class="w-full border rounded px-3 py-2"></div>
        <div class="flex justify-end gap-3 mt-2"><button id="btnCancelEdit" class="px-4 py-2 rounded border">Cancelar</button><button id="btnSaveEdit" class="px-4 py-2 rounded bg-blue-600 text-white">Salvar</button></div>
      </div>
    </div>
  </div>

<script>
/* ---------- CONFIG: sua URL do Web App (implante substitua se necessário) ---------- */
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbx0Rf9qSgLxtDM3fMcQJLgnRKSck_k_ao6bV4N0zYblBp0QQriFnniylkHnQZY1M8ou/exec";

/* ---------- utilitários ---------- */
let selectedDate = new Date().toISOString().slice(0,10);
const datePicker = document.getElementById('datePicker');
const prevDayBtn = document.getElementById('prevDay');
const nextDayBtn = document.getElementById('nextDay');

function keyFor(kind, date = selectedDate){ return `${kind}_${date}`; }
function salvarLocal(chave, obj){ localStorage.setItem(chave, JSON.stringify(obj)); }
function carregarLocal(chave, padrao){ const raw = localStorage.getItem(chave); return raw ? JSON.parse(raw) : padrao; }
function genId(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,7); }
function escapeHTML(str=''){ return String(str).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ---------- date controls ---------- */
function setDate(d){ selectedDate = d; datePicker.value = d; loadAllData(); const relDataEl=document.getElementById('relData'); if(relDataEl) relDataEl.value = d; }
datePicker.addEventListener('change', e=> setDate(e.target.value));
prevDayBtn.addEventListener('click', ()=>{ const d=new Date(selectedDate); d.setDate(d.getDate()-1); setDate(d.toISOString().slice(0,10)); });
nextDayBtn.addEventListener('click', ()=>{ const d=new Date(selectedDate); d.setDate(d.getDate()+1); setDate(d.toISOString().slice(0,10)); });
datePicker.value = selectedDate;
if(document.getElementById('relData')) document.getElementById('relData').value = selectedDate;

/* ---------- tabs ---------- */
const tabs = {
  veiculosBtn: document.getElementById('tabVeiculosBtn'),
  bicicletaBtn: document.getElementById('tabBicicletaBtn'),
  fechamentoBtn: document.getElementById('tabFechamentoBtn'),
  relatorioBtn: document.getElementById('tabRelatorioBtn'),
  infoBtn: document.getElementById('tabInfoBtn')
};
const tabContents = {
  veiculos: document.getElementById('veiculos'),
  bicicleta: document.getElementById('bicicleta'),
  fechamento: document.getElementById('fechamento'),
  relatorio: document.getElementById('relatorio'),
  info: document.getElementById('info')
};
function setActiveTabButton(btn){
  Object.values(tabs).forEach(b=>{
    b.classList.remove('bg-blue-600','text-white');
    b.classList.add('bg-white','text-gray-700','border');
  });
  btn.classList.remove('bg-white','text-gray-700','border');
  btn.classList.add('bg-blue-600','text-white');
}
function openTab(evt,name){
  Object.values(tabContents).forEach(c=>c.classList.add('hidden'));
  tabContents[name].classList.remove('hidden');
  if(evt&&evt.currentTarget) setActiveTabButton(evt.currentTarget);
  // scroll active tab into view for small screens
  try{ evt.currentTarget.scrollIntoView({inline:'center', behavior:'smooth'}); }catch(e){}
}
tabs.veiculosBtn.addEventListener('click', e=>openTab(e,'veiculos'));
tabs.bicicletaBtn.addEventListener('click', e=>openTab(e,'bicicleta'));
tabs.fechamentoBtn.addEventListener('click', e=>openTab(e,'fechamento'));
tabs.relatorioBtn.addEventListener('click', e=>openTab(e,'relatorio'));
tabs.infoBtn.addEventListener('click', e=>openTab(e,'info'));
setActiveTabButton(tabs.veiculosBtn);
tabContents.veiculos.classList.remove('hidden');

/* ---------- veículos (render + CRUD local) ---------- */
const placaInput = document.getElementById('placaInput');
const placaErro = document.getElementById('placaErro');
const regexPlaca = /^[A-Z]{3}-\d[A-Z0-9]\d{2}$/;
const formVeiculos = document.getElementById('formVeiculos');
const registrosVeiculosBody = document.getElementById('registrosVeiculosBody');
let registrosVeiculos = [];
placaInput.addEventListener('input', e=>{ let v=e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,''); if(v.length>3) v = v.slice(0,3)+'-'+v.slice(3,7); e.target.value = v.slice(0,8); placaErro.classList.add('hidden'); placaInput.classList.remove('border-red-500'); });
function validarPlaca(p){ return regexPlaca.test((p||'').toUpperCase()); }

function renderVeiculos(){
  registrosVeiculosBody.innerHTML='';
  if(!registrosVeiculos.length){
    registrosVeiculosBody.innerHTML='<tr><td class="px-3 py-6 text-gray-500" colspan="5">Nenhum registro para a data selecionada.</td></tr>';
    return;
  }
  registrosVeiculos.forEach(r=>{
    const tr=document.createElement('tr'); tr.style.position='relative';
    tr.innerHTML = `
      <td class="border px-3 py-2 text-sm">${escapeHTML(r.placa)}</td>
      <td class="border px-3 py-2 text-sm">${escapeHTML(r.hora)}</td>
      <td class="border px-3 py-2 text-sm break-words">${escapeHTML(r.motivo)}</td>
      <td class="border px-3 py-2 text-sm">${escapeHTML(r.operador)}</td>
      <td class="border px-3 py-2 text-center">
        <div class="relative inline-block">
          <button class="text-sm w-6 h-6 leading-6 rounded hover:bg-gray-100" onclick="abrirMenuRegistro(event,'${r.id}')">⋮</button>
          <div id="menu-${r.id}" class="menu hidden absolute right-0 mt-1 w-28 bg-white border rounded shadow">
            <button class="block w-full text-left px-3 py-2 hover:bg-gray-100" onclick="abrirEditar('${r.id}')">Editar</button>
            <button class="block w-full text-left px-3 py-2 hover:bg-gray-100 text-red-600" onclick="excluirRegistro('${r.id}')">Excluir</button>
          </div>
        </div>
      </td>`;
    registrosVeiculosBody.appendChild(tr);
  });
}

document.addEventListener('click', ()=>{ document.querySelectorAll('[id^="menu-"]').forEach(m=>m.classList.add('hidden')); document.querySelectorAll('[id^="menuf-"]').forEach(m=>m.classList.add('hidden')); document.querySelectorAll('[id^="menur-"]').forEach(m=>m.classList.add('hidden')); });
function abrirMenuRegistro(e,id){ e.stopPropagation(); document.querySelectorAll('[id^="menu-"]').forEach(m=>m.classList.add('hidden')); const menu=document.getElementById(`menu-${id}`); if(menu) menu.classList.toggle('hidden'); }

formVeiculos.addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const placa = placaInput.value.trim().toUpperCase();
  const hora = document.getElementById('horaInput').value.trim();
  const motivo = document.getElementById('motivoInput').value.trim();
  const operador = document.getElementById('operadorInput').value.trim();
  if(!validarPlaca(placa)){ placaErro.classList.remove('hidden'); placaInput.classList.add('border-red-500'); return; }
  if(!hora||!motivo||!operador){ alert('Preencha todos os campos.'); return; }
  const novo = { id: genId(), placa, hora, motivo, operador };
  registrosVeiculos.push(novo);
  salvarLocal(keyFor('veiculos'), registrosVeiculos);
  renderVeiculos();
  formVeiculos.reset();
  document.getElementById('msgVeiculo').classList.remove('hidden');
  setTimeout(()=>document.getElementById('msgVeiculo').classList.add('hidden'),1600);

  // enviar ao Web App
  try{
    if(WEBAPP_URL && !WEBAPP_URL.includes('COLE_AQUI')){
      const payload = { acao:'salvar_veiculo', data:selectedDate, registro:novo };
      const resp = await fetch(WEBAPP_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      console.log('WebApp save vehicle:', await resp.text());
    }
  }catch(err){ console.error('Erro enviar veiculo:',err); }
});

/* ---------- edição / exclusão veículos (modal) ---------- */
const modalEdit = document.getElementById('modalEdit');
const editPlaca = document.getElementById('editPlaca');
const editHora = document.getElementById('editHora');
const editMotivo = document.getElementById('editMotivo');
const editOperador = document.getElementById('editOperador');
const btnCancelEdit = document.getElementById('btnCancelEdit');
const btnSaveEdit = document.getElementById('btnSaveEdit');
let currentEditId = null;

function abrirEditar(id){
  const r = registrosVeiculos.find(x=>x.id===id);
  if(!r) return;
  currentEditId = id;
  editPlaca.value = r.placa || '';
  editHora.value = r.hora || '';
  editMotivo.value = r.motivo || '';
  editOperador.value = r.operador || '';
  modalEdit.classList.remove('hidden');
}

btnCancelEdit.addEventListener('click', ()=>{ currentEditId = null; modalEdit.classList.add('hidden'); });

btnSaveEdit.addEventListener('click', async ()=>{
  if(!currentEditId) return;
  const placa = (editPlaca.value||'').trim().toUpperCase();
  const hora = (editHora.value||'').trim();
  const motivo = (editMotivo.value||'').trim();
  const operador = (editOperador.value||'').trim();
  if(!validarPlaca(placa)){ alert('Placa inválida.'); return; }
  if(!hora||!motivo||!operador){ alert('Preencha todos os campos.'); return; }
  const idx = registrosVeiculos.findIndex(x=>x.id===currentEditId);
  if(idx===-1){ modalEdit.classList.add('hidden'); return; }
  registrosVeiculos[idx] = { id: currentEditId, placa, hora, motivo, operador };
  salvarLocal(keyFor('veiculos'), registrosVeiculos);
  renderVeiculos();
  modalEdit.classList.add('hidden');

  // enviar edição ao Web App
  try{
    if(WEBAPP_URL && !WEBAPP_URL.includes('COLE_AQUI')){
      const payload = { acao:'salvar_veiculo', data:selectedDate, registro: registrosVeiculos[idx] };
      const resp = await fetch(WEBAPP_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      console.log('WebApp edit vehicle:', await resp.text());
    }
  }catch(err){ console.error('Erro enviar edição:',err); }

  currentEditId = null;
});

function excluirRegistro(id){
  if(!confirm('Excluir este registro?')) return;
  registrosVeiculos = registrosVeiculos.filter(r=>r.id!==id);
  salvarLocal(keyFor('veiculos'), registrosVeiculos);
  renderVeiculos();

  // notificar Web App (acao: excluir_veiculo)
  (async ()=>{
    try{
      if(WEBAPP_URL && !WEBAPP_URL.includes('COLE_AQUI')){
        const payload = { acao:'excluir_veiculo', data:selectedDate, id };
        const resp = await fetch(WEBAPP_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        console.log('WebApp delete vehicle:', await resp.text());
      }
    }catch(err){ console.error('Erro notificar exclusão:', err); }
  })();
}

/* ---------- bicicleta (construção da tabela + eventos) ---------- */
const bicicletaTableEl = document.getElementById('bicicletaTable');
const mediaEl = document.getElementById('mediaBicicleta');
const anotacoesEl = document.getElementById('anotacoesBicicleta');
let bicicletaData = { valores: Array(12).fill(''), anotacoes: '' };

function construirTabelaBicicleta(){
  bicicletaTableEl.innerHTML = '';
  for(let i=0;i<12;i++){
    const h = 10 + i;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="border px-3 py-2 text-sm">${h}h - ${h+1}h</td>
                    <td class="border px-3 py-2"><input type="text" inputmode="decimal" data-index="${i}" class="bicicletaInput w-full border rounded px-3 py-2" value="${escapeHTML(bicicletaData.valores[i]||'')}"></td>`;
    bicicletaTableEl.appendChild(tr);
  }
  anotacoesEl.value = bicicletaData.anotacoes || '';
  conectarEventosBicicleta();
  calcularMedia();
}

function conectarEventosBicicleta(){
  document.querySelectorAll('.bicicletaInput').forEach(inp=>{
    inp.addEventListener('input', ()=>{
      const idx = Number(inp.dataset.index);
      bicicletaData.valores[idx] = inp.value;
      salvarLocal(keyFor('bicicleta'), bicicletaData);
      calcularMedia();
    });
    inp.addEventListener('blur', ()=>{
      const idx = Number(inp.dataset.index);
      bicicletaData.valores[idx] = inp.value;
      salvarLocal(keyFor('bicicleta'), bicicletaData);
      calcularMedia();
    });
  });
  anotacoesEl.addEventListener('input', ()=>{
    bicicletaData.anotacoes = anotacoesEl.value;
    salvarLocal(keyFor('bicicleta'), bicicletaData);
    document.getElementById('msgBic').classList.remove('hidden');
    setTimeout(()=>document.getElementById('msgBic').classList.add('hidden'),1200);
  });
}

function parseNumero(v){ if((v === '' || v === null || v===undefined) && v!==0) return 0; const s=String(v).trim().replace(',','.'); const n=parseFloat(s); return isNaN(n)?0:n; }
function calcularMedia(){ const soma = bicicletaData.valores.reduce((acc,cur)=>acc+parseNumero(cur),0); const media = soma/12; mediaEl.textContent = media.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}); }

/* Compartilhar bicicleta (mantido) */
document.getElementById('btnCompartilhar').addEventListener('click', async ()=>{
  try{
    const el=document.getElementById('bicicletaCard');
    const imgs=el.querySelectorAll('img');
    await Promise.all(Array.from(imgs).map(img=> img.complete?Promise.resolve():new Promise(r=>{img.onload=img.onerror=r})));
    const canvas=await html2canvas(el,{scale:2,useCORS:true,backgroundColor:'#ffffff'});
    const blob = await new Promise(r=>canvas.toBlob(r,'image/png'));
    const fileName = `bicicleta_${selectedDate}_${new Date().toISOString().slice(11,19).replace(/:/g,'-')}.png`;
    if(navigator.canShare && navigator.canShare({files:[new File([blob],fileName,{type:'image/png'})]})){
      try{ await navigator.share({files:[new File([blob],fileName,{type:'image/png'})], title:'Controle de Bicicleta', text:`Registro ${selectedDate}`}); return; }catch(err){}
    }
    const url=URL.createObjectURL(blob); window.open(url,'_blank');
  }catch(err){ alert('Erro ao gerar compartilhamento.'); console.error(err); }
});

/* ---------- Hard-wrap helper ---------- */
function hardWrapText(text, maxPx, font) {
  const paragraphs = String(text).split(/\r\n|\n/);
  const canvas = hardWrapText._canvas || (hardWrapText._canvas = document.createElement('canvas'));
  const ctx = canvas.getContext('2d');
  ctx.font = font;
  const wrapped = paragraphs.map(par => {
    const words = par.split(/(\s+)/);
    let line = '';
    const lines = [];
    for (let token of words) {
      const test = line + token;
      const w = ctx.measureText(test).width;
      if (w > maxPx && line !== '') {
        lines.push(line.trimEnd());
        if (ctx.measureText(token).width > maxPx) {
          let chunk = '';
          for (let ch of token) {
            const test2 = chunk + ch;
            if (ctx.measureText(test2).width > maxPx) {
              lines.push(chunk);
              chunk = ch;
            } else chunk = test2;
          }
          if (chunk) line = chunk;
          else line = '';
        } else {
          line = token;
        }
      } else {
        line = test;
      }
    }
    if (line) lines.push(line.trimEnd());
    return lines.join('\n');
  });
  return wrapped.join('\n');
}
function fontForElement(el){
  const cs = window.getComputedStyle(el);
  const fontSize = cs.fontSize || '14px';
  const fontFamily = cs.fontFamily || 'Arial, sans-serif';
  const fontWeight = cs.fontWeight || '400';
  return `${fontWeight} ${fontSize} ${fontFamily}`;
}

/* ---------- Fechamento (hard-wrap) ---------- */
const formFechamento = document.getElementById('formFechamento');
const listaFechamentos = document.getElementById('listaFechamentos');
let fechamentos = [];
function renderFechamentos(){
  listaFechamentos.innerHTML='';
  if(!fechamentos.length){ listaFechamentos.innerHTML='<p class="text-sm text-gray-600">Nenhum fechamento salvo para a data selecionada.</p>'; return; }
  fechamentos.forEach(r=>{
    const div=document.createElement('div'); div.className='border rounded p-3 mb-3 relative bg-gray-50';
    const altLabel = document.createElement('div'); altLabel.className='text-sm'; const s= document.createElement('strong'); s.textContent='Alterações nos terminais: '; altLabel.appendChild(s);
    const altText = document.createElement('div'); altText.className='text-sm preserve'; altText.textContent = r.alteracoes || '';
    div.appendChild(altLabel); div.appendChild(altText);
    const cred = document.createElement('div'); cred.className='text-sm'; cred.textContent = `Credencial na guarita: ${r.credencial ? 'Sim':'Não'}`; div.appendChild(cred);
    const chave = document.createElement('div'); chave.className='text-sm'; chave.textContent = `Chave na guarita: ${r.chave ? 'Sim':'Não'}`; div.appendChild(chave);
    const he = document.createElement('div'); he.className='text-sm'; he.textContent = `Hora fechamento entrada: ${r.horaEntrada||''}`; div.appendChild(he);
    const hs = document.createElement('div'); hs.className='text-sm'; hs.textContent = `Hora fechamento saída: ${r.horaSaida||''}`; div.appendChild(hs);
    const hp = document.createElement('div'); hp.className='text-sm'; hp.textContent = `Hora fechamento pedestre: ${r.horaPedestre||''}`; div.appendChild(hp);
    listaFechamentos.appendChild(div);
  });
}
formFechamento.addEventListener('submit', ev=>{
  ev.preventDefault();
  const ta = document.getElementById('alteracoesTerminais');
  const maxPx = ta.clientWidth - 8;
  const font = fontForElement(ta);
  const raw = ta.value || '';
  const wrapped = hardWrapText(raw, maxPx, font);
  const credencial = document.getElementById('credencialGuarita').checked;
  const chave = document.getElementById('chaveGuarita').checked;
  const horaEntrada = document.getElementById('horaFechEntrada').value;
  const horaSaida = document.getElementById('horaFechSaida').value;
  const horaPedestre = document.getElementById('horaFechPedestre').value;
  const rec = { id: genId(), alteracoes: wrapped, credencial, chave, horaEntrada, horaSaida, horaPedestre };
  fechamentos.push(rec);
  salvarLocal(keyFor('fechamento'), fechamentos);
  renderFechamentos();
  formFechamento.reset();
  document.getElementById('msgFech').classList.remove('hidden');
  setTimeout(()=>document.getElementById('msgFech').classList.add('hidden'),1200);
});

/* ---------- Relatórios ---------- */
const formRelatorio = document.getElementById('formRelatorio');
const listaRelatorios = document.getElementById('listaRelatorios');
let relatorios = [];
function renderRelatorios(){
  listaRelatorios.innerHTML='';
  if(!relatorios.length){ listaRelatorios.innerHTML='<p class="text-sm text-gray-600">Nenhum relatório para a data selecionada.</p>'; return; }
  relatorios.forEach(r=>{
    const div=document.createElement('div'); div.className='border rounded p-3 mb-3 relative bg-gray-50';
    const nome = document.createElement('div'); nome.className='text-sm'; nome.textContent = `Nome: ${r.nome}`; div.appendChild(nome);
    const data = document.createElement('div'); data.className='text-sm'; data.textContent = `Data: ${r.data}`; div.appendChild(data);
    const turnoLabel = r.turno === '08-20' ? '08:00 - 20:00' : (r.turno === '11-23' ? '11:00 - 23:00' : '13:00 - 01:00');
    const turnoDiv = document.createElement('div'); turnoDiv.className='text-sm'; turnoDiv.textContent = `Turno: ${turnoLabel}`; div.appendChild(turnoDiv);
    const infoLabel = document.createElement('div'); infoLabel.className='text-sm'; const s=document.createElement('strong'); s.textContent='Informações: '; infoLabel.appendChild(s);
    const infoText = document.createElement('div'); infoText.className='text-sm preserve'; infoText.textContent = r.info || ''; div.appendChild(infoLabel); div.appendChild(infoText);
    listaRelatorios.appendChild(div);
  });
}
formRelatorio.addEventListener('submit', ev=>{
  ev.preventDefault();
  const nome = document.getElementById('relNome').value.trim();
  if(!nome){ alert('Informe o nome.'); return; }
  const data = document.getElementById('relData').value || selectedDate;
  const turno = document.getElementById('relTurno').value;
  const ta = document.getElementById('relInfo');
  const raw = ta.value || '';
  const maxPx = ta.clientWidth - 8;
  const font = fontForElement(ta);
  const wrapped = hardWrapText(raw, maxPx, font);
  const rec = { id: genId(), nome, data, turno, info: wrapped };
  relatorios.push(rec);
  salvarLocal(keyFor('relatorio'), relatorios);
  renderRelatorios();
  formRelatorio.reset();
  document.getElementById('relData').value = selectedDate;
  document.getElementById('msgRel').classList.remove('hidden');
  setTimeout(()=>document.getElementById('msgRel').classList.add('hidden'),1200);
});

/* ---------- Upload de fotos: preview + envio ao Apps Script ---------- */
function setupPhotoUpload(inputId, previewContainerId, sectionLabel, extraDataFn){
  const input = document.getElementById(inputId);
  const preview = document.getElementById(previewContainerId);
  if(!input || !preview) return;
  input.addEventListener('change', async ()=>{
    const file = input.files && input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = async (e)=>{
      const img = document.createElement('img');
      img.className = 'preview-img';
      img.src = e.target.result;
      preview.prepend(img);
      const payload = {
        imagem: e.target.result,
        nomeArquivo: file.name || `${sectionLabel}_${selectedDate}.png`,
        data: selectedDate,
        secao: sectionLabel,
        meta: extraDataFn ? extraDataFn() : {}
      };
      if(!WEBAPP_URL || WEBAPP_URL.includes("COLE_AQUI")) {
        alert("Configure a URL do Web App (WEBAPP_URL) antes de enviar.");
        return;
      }
      try{
        const resp = await fetch(WEBAPP_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ acao:'salvar_imagem', payload })
        });
        const text = await resp.text();
        alert("Foto salva no Google Drive: " + text);
      }catch(err){
        console.error(err);
        alert("Erro ao enviar foto para o Google Drive.");
      }
    };
    reader.readAsDataURL(file);
  });
}
setupPhotoUpload("fotoBicicleta","previewBicicleta","bicicleta", ()=>({ anotacoes: document.getElementById('anotacoesBicicleta')?.value || '' }));
setupPhotoUpload("fotoFechamento","previewFechamento","fechamento", ()=>({
  alteracoes: document.getElementById('alteracoesTerminais')?.value || '',
  credencial: document.getElementById('credencialGuarita')?.checked || false,
  chave: document.getElementById('chaveGuarita')?.checked || false,
  horaEntrada: document.getElementById('horaFechEntrada')?.value || '',
  horaSaida: document.getElementById('horaFechSaida')?.value || '',
  horaPedestre: document.getElementById('horaFechPedestre')?.value || ''
}));
setupPhotoUpload("fotoRelatorio","previewRelatorio","relatorio", ()=>({
  nome: document.getElementById('relNome')?.value || '',
  turno: document.getElementById('relTurno')?.value || '',
  info: document.getElementById('relInfo')?.value || ''
}));
setupPhotoUpload("fotoInfo","previewInfo","informacoes", ()=>({
  descricao: document.getElementById('infoDescricao')?.value || ''
}));

/* ---------- Função para salvar Informações supervisor no Drive via WebApp ---------- */
document.getElementById('btnSalvarInfo').addEventListener('click', async ()=>{
  const descricao = document.getElementById('infoDescricao').value.trim();
  if(!descricao){ alert('Escreva algo antes de salvar.'); return; }
  const payload = {
    acao: 'salvar_informacoes',
    data: selectedDate,
    secao: 'informacoes_supervisor',
    registro: {
      descricao: descricao,
      timestamp: new Date().toISOString()
    }
  };
  try{
    const resp = await fetch(WEBAPP_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const text = await resp.text();
    document.getElementById('msgInfo').classList.remove('hidden');
    setTimeout(()=>document.getElementById('msgInfo').classList.add('hidden'),1600);
    alert('Informações salvas no Drive: ' + text);
  }catch(err){
    console.error('Erro ao salvar informações:', err);
    alert('Falha ao salvar informações no Drive.');
  }
});

/* ---------- load / init ---------- */
function loadAllData(){
  registrosVeiculos = carregarLocal(keyFor('veiculos'), []);
  renderVeiculos();
  bicicletaData = carregarLocal(keyFor('bicicleta'), { valores: Array(12).fill(''), anotacoes: '' });
  construirTabelaBicicleta();
  fechamentos = carregarLocal(keyFor('fechamento'), []);
  renderFechamentos();
  relatorios = carregarLocal(keyFor('relatorio'), []);
  renderRelatorios();
  // carregar texto de informações do supervisor se tiver local (opcional)
  const infoLocal = carregarLocal(keyFor('info'), { descricao: '' });
  if(infoLocal && infoLocal.descricao) document.getElementById('infoDescricao').value = infoLocal.descricao;
}
loadAllData();

document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ document.getElementById('modalEdit').classList.add('hidden'); document.querySelectorAll('[id^="menu-"]').forEach(m=>m.classList.add('hidden')); document.querySelectorAll('[id^="menuf-"]').forEach(m=>m.classList.add('hidden')); document.querySelectorAll('[id^="menur-"]').forEach(m=>m.classList.add('hidden')); } });

/* export functions for inline handlers */
window.abrirMenuRegistro = abrirMenuRegistro;
window.abrirEditar = abrirEditar;
window.excluirRegistro = excluirRegistro;
window.abrirMenuFechamento = abrirMenuFechamento;
window.editarFechamento = editarFechamento;
window.excluirFechamento = excluirFechamento;
window.abrirMenuRelatorio = abrirMenuRelatorio;
window.editarRelatorio = editarRelatorio;
window.excluirRelatorio = excluirRelatorio;
</script>

</body>
</html>
