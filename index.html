<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Relatório PGE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>

<style>
.tab-active {
    background-color: #1d4ed8 !important;
    color: white !important;
}
.hidden { display: none; }
</style>

<script>
// -------------------------------------------------------
// CONFIGURAÇÃO
// -------------------------------------------------------
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycby2Ftp5u1u6nJ5AJdy7gWuzEK7inZvSTT3Tx1IPAVY4tMI9BJpneFHEiAt0l20_eiGv/exec";

// -------------------------------------------------------
// TROCA DE ABAS
// -------------------------------------------------------
function activateTab(tabId) {
    document.querySelectorAll(".tab-content").forEach(el => el.classList.add("hidden"));
    document.querySelectorAll(".tab-btn").forEach(el => el.classList.remove("tab-active"));
    document.getElementById(tabId).classList.remove("hidden");
    document.getElementById("btn-" + tabId).classList.add("tab-active");
}

// -------------------------------------------------------
// ENVIO AO WEBAPP
// -------------------------------------------------------
async function enviar(acao, payload) {
    const body = JSON.stringify({ acao, payload });

    try {
        const res = await fetch(WEBAPP_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body
        });

        alert("Registro enviado com sucesso.");
    } catch (erro) {
        alert("Erro de rede ao enviar ao WebApp.");
        console.error(erro);
    }
}

// -------------------------------------------------------
// SUBMISSÕES
// -------------------------------------------------------
function salvarVeiculo() {
    const dado = {
        placa: document.getElementById("placa").value,
        hora: document.getElementById("horaSaida").value,
        motivo: document.getElementById("motivo").value,
        operador: document.getElementById("operador").value,
        data: document.getElementById("dataDia").value
    };
    enviar("salvar_veiculo", dado);
}

function salvarBike() {
    const dado = {
        anotacoes: document.getElementById("bikeAnotacoes").value,
        valores: document.getElementById("bikeValores").value.split(","),
        data: document.getElementById("dataDia").value
    };
    enviar("salvar_bicicleta", dado);
}

function salvarFechamento() {
    const dado = {
        alteracoes: document.getElementById("p4Alteracoes").value,
        credencial: document.getElementById("p4Credencial").checked,
        chave: document.getElementById("p4Chave").checked,
        horaEntrada: document.getElementById("p4Entrada").value,
        horaSaida: document.getElementById("p4Saida").value,
        horaPedestre: document.getElementById("p4Pedestre").value,
        data: document.getElementById("dataDia").value
    };
    enviar("salvar_fechamento", dado);
}

function salvarRelatorio() {
    const dado = {
        nome: document.getElementById("relNome").value,
        turno: document.getElementById("relTurno").value,
        info: document.getElementById("relInfo").value,
        data: document.getElementById("dataDia").value
    };
    enviar("salvar_relatorio", dado);
}

function salvarInformacoes() {
    const dado = {
        descricao: document.getElementById("infoDescricao").value,
        data: document.getElementById("dataDia").value
    };
    enviar("salvar_informacoes", dado);
}

// -------------------------------------------------------
// CARREGAMENTO DE REGISTROS DO DIA
// -------------------------------------------------------
async function carregarRegistros() {
    const data = document.getElementById("dataDia").value;
    const url = WEBAPP_URL + "?action=list&date=" + data;

    try {
        const resp = await fetch(url);
        const json = await resp.json();
        montarTabela(json.records || []);
    } catch (e) {
        console.error(e);
    }
}

function montarTabela(lista) {
    const tabela = document.getElementById("tabelaRegistros");
    tabela.innerHTML = "";

    lista.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td class="border px-2 py-1">${r.tipo}</td>
            <td class="border px-2 py-1">${r.date}</td>
            <td class="border px-2 py-1">${r.section}</td>
            <td class="border px-2 py-1"><a href="${r.url}" target="_blank" class="text-blue-600 underline">Abrir</a></td>
        `;
        tabela.appendChild(tr);
    });
}
</script>

</head>

<body class="bg-gray-100 min-h-screen">

<div class="max-w-5xl mx-auto p-4">

<h1 class="text-2xl font-bold mb-4">Relatório PGE</h1>

<!-- seleção de data -->
<div class="mb-4">
    <label class="font-semibold">Data:</label>
    <input type="date" id="dataDia" class="px-3 py-2 border rounded" onchange="carregarRegistros()" />
</div>

<!-- MENU DE ABAS -->
<div class="flex gap-2 mb-4">
    <button id="btn-veiculos" class="tab-btn tab-active px-3 py-2 bg-white border rounded" onclick="activateTab('veiculos')">Saída de veículos</button>
    <button id="btn-bicicleta" class="tab-btn px-3 py-2 bg-white border rounded" onclick="activateTab('bicicleta')">Controle de bicicleta</button>
    <button id="btn-p4" class="tab-btn px-3 py-2 bg-white border rounded" onclick="activateTab('p4')">Fechamento P4</button>
    <button id="btn-relatorio" class="tab-btn px-3 py-2 bg-white border rounded" onclick="activateTab('relatorio')">Relatório operador</button>
    <button id="btn-informacoes" class="tab-btn px-3 py-2 bg-white border rounded" onclick="activateTab('informacoes')">Informações</button>
</div>

<!-- CONTEÚDO DAS ABAS -->
<!-- VEÍCULOS -->
<div id="veiculos" class="tab-content">
    <div class="bg-white p-4 rounded shadow">
        <h2 class="font-semibold mb-3">Registrar saída de veículo</h2>

        <label>Placa:</label>
        <input id="placa" class="border rounded px-3 py-2 w-full mb-2">

        <label>Hora:</label>
        <input id="horaSaida" type="time" class="border rounded px-3 py-2 w-full mb-2">

        <label>Motivo:</label>
        <input id="motivo" class="border rounded px-3 py-2 w-full mb-2">

        <label>Operador:</label>
        <input id="operador" class="border rounded px-3 py-2 w-full mb-3">

        <button onclick="salvarVeiculo()" class="px-4 py-2 bg-blue-600 text-white rounded">Registrar</button>
    </div>
</div>

<!-- BICICLETA -->
<div id="bicicleta" class="tab-content hidden">
    <div class="bg-white p-4 rounded shadow">
        <h2 class="font-semibold mb-3">Controle de bicicleta</h2>

        <label>Anotações:</label>
        <textarea id="bikeAnotacoes" class="border rounded w-full px-3 py-2 mb-2"></textarea>

        <label>Valores (separados por vírgula):</label>
        <input id="bikeValores" class="border rounded px-3 py-2 w-full mb-3">

        <button onclick="salvarBike()" class="px-4 py-2 bg-blue-600 text-white rounded">Registrar</button>
    </div>
</div>

<!-- P4 -->
<div id="p4" class="tab-content hidden">
    <div class="bg-white p-4 rounded shadow">
        <h2 class="font-semibold mb-3">Fechamento P4</h2>

        <label>Alterações:</label>
        <textarea id="p4Alteracoes" class="border rounded w-full px-3 py-2 mb-2"></textarea>

        <div class="mb-2">
            <input type="checkbox" id="p4Credencial"> Credencial
        </div>

        <div class="mb-2">
            <input type="checkbox" id="p4Chave"> Chave
        </div>

        <label>Hora entrada:</label>
        <input type="time" id="p4Entrada" class="border rounded w-full mb-2">

        <label>Hora saída:</label>
        <input type="time" id="p4Saida" class="border rounded w-full mb-2">

        <label>Hora pedestre:</label>
        <input type="time" id="p4Pedestre" class="border rounded w-full mb-3">

        <button onclick="salvarFechamento()" class="px-4 py-2 bg-blue-600 text-white rounded">Registrar</button>
    </div>
</div>

<!-- RELATÓRIO OPERADOR -->
<div id="relatorio" class="tab-content hidden">
    <div class="bg-white p-4 rounded shadow">
        <h2 class="font-semibold mb-3">Relatório do operador</h2>

        <label>Nome:</label>
        <input id="relNome" class="border rounded px-3 py-2 w-full mb-2">

        <label>Turno:</label>
        <input id="relTurno" class="border rounded px-3 py-2 w-full mb-2">

        <label>Informações:</label>
        <textarea id="relInfo" class="border rounded w-full px-3 py-2 mb-3"></textarea>

        <button onclick="salvarRelatorio()" class="px-4 py-2 bg-blue-600 text-white rounded">Registrar</button>
    </div>
</div>

<!-- INFORMAÇÕES -->
<div id="informacoes" class="tab-content hidden">
    <div class="bg-white p-4 rounded shadow">
        <h2 class="font-semibold mb-3">Informações</h2>

        <textarea id="infoDescricao" class="border rounded w-full px-3 py-2 mb-3"></textarea>

        <button onclick="salvarInformacoes()" class="px-4 py-2 bg-blue-600 text-white rounded">Registrar</button>
    </div>
</div>

<!-- REGISTROS DO DIA -->
<div class="bg-white p-4 mt-6 rounded shadow">
    <h2 class="font-semibold mb-3">Registros do dia</h2>

    <table class="w-full border">
        <thead>
            <tr class="bg-gray-200">
                <th class="border px-2 py-1">Tipo</th>
                <th class="border px-2 py-1">Data</th>
                <th class="border px-2 py-1">Seção</th>
                <th class="border px-2 py-1">Arquivo</th>
            </tr>
        </thead>
        <tbody id="tabelaRegistros"></tbody>
    </table>
</div>

</div>

<script>
// Inicializar data de hoje
document.getElementById("dataDia").value = new Date().toISOString().slice(0,10);
carregarRegistros();
</script>

</body>
</html>
